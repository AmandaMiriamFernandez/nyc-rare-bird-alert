<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Rare Bird Alert - Premium Edition</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #7c3aed;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f1f5f9;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Removed animated background particles */

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            z-index: 100;
            border-bottom: 3px solid var(--primary);
        }

        .header h1 {
            color: var(--dark);
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        /* Removed bird logo animations */

        .header p {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 300;
        }

        /* Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px auto;
            max-width: 1400px;
            padding: 0 20px;
            position: relative;
            z-index: 10;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .stat-card:hover::before {
            opacity: 0.1;
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border-color: var(--primary);
        }

        .stat-card > * {
            position: relative;
            z-index: 1;
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        /* Map Container */
        .map-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 800px;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .map-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--dark);
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5);
        }

        #map {
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .sidebar-header {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 15px 45px 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1.2em;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent), #d97706);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* Date Filter */
        .date-filter {
            margin-bottom: 15px;
        }

        .date-label {
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .date-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .date-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Bird List */
        .bird-list-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .bird-item {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 5px solid var(--primary);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .bird-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bird-item:hover::before {
            opacity: 0.1;
        }

        .bird-item:hover {
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border-left-color: var(--secondary);
        }

        .bird-item > * {
            position: relative;
            z-index: 1;
        }

        .bird-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bird-count {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .bird-location, .bird-date {
            color: #64748b;
            font-size: 0.9em;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Charts Section */
        .charts-container {
            max-height: 300px;
        }

        /* Timeline */
        .timeline-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .timeline-item {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid var(--success);
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .timeline-date {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .timeline-stats {
            color: #64748b;
            font-size: 0.9em;
        }

        /* Share Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
        }

        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .share-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .share-twitter {
            background: #1DA1F2;
            color: white;
        }

        .share-facebook {
            background: #4267B2;
            color: white;
        }

        .share-email {
            background: #EA4335;
            color: white;
        }

        .share-copy {
            background: #64748b;
            color: white;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .close-modal {
            background: #e2e8f0;
            color: var(--dark);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        /* Pulse animation for new data */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .new-data {
            animation: pulse 2s ease-in-out 3;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>NYC Rare Bird Alert</h1>
        <p>Discover rare and notable bird sightings across New York City in real-time</p>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-binoculars"></i></div>
            <div class="stat-number" id="total-sightings">0</div>
            <div class="stat-label">Total Sightings</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-list"></i></div>
            <div class="stat-number" id="unique-species">0</div>
            <div class="stat-label">Unique Species</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-number" id="last-updated">--:--</div>
            <div class="stat-label">Last Updated</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-trophy"></i></div>
            <div class="stat-number" id="top-species">--</div>
            <div class="stat-label">Most Spotted</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="content-wrapper">
            <!-- Map Section -->
            <div class="map-container">
                <div class="map-header">
                    <div class="map-title"><i class="fas fa-map-marked-alt"></i> Interactive Map</div>
                    <div class="map-controls">
                        <button class="map-btn" onclick="enableClustering()">
                            <i class="fas fa-layer-group"></i> Cluster
                        </button>
                        <button class="map-btn" onclick="enableHeatmap()">
                            <i class="fas fa-fire"></i> Heatmap
                        </button>
                    </div>
                </div>
                <div id="map"></div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Controls Card -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="fas fa-sliders-h sidebar-icon"></i>
                        Controls
                    </div>

                    <div class="search-box">
                        <input
                            type="text"
                            class="search-input"
                            id="search-input"
                            placeholder="Search species or location..."
                        >
                        <i class="fas fa-search search-icon"></i>
                    </div>

                    <div class="date-filter">
                        <div class="date-label">Filter by Date Range</div>
                        <select class="date-select" id="date-range" onchange="filterByDateRange()">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn btn-primary" onclick="loadData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="action-btn btn-success" onclick="loadAllHistory()">
                            <i class="fas fa-history"></i> History
                        </button>
                    </div>

                    <button class="action-btn btn-accent" onclick="openShareModal()">
                        <i class="fas fa-share-alt"></i> Share Sightings
                    </button>
                </div>

                <!-- Bird List Card -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="fas fa-list sidebar-icon"></i>
                        Recent Sightings
                    </div>
                    <div class="bird-list-container" id="bird-list-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading bird data...
                        </div>
                    </div>
                </div>

                <!-- Charts Card -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="fas fa-chart-bar sidebar-icon"></i>
                        Species Chart
                    </div>
                    <div class="charts-container">
                        <canvas id="speciesChart"></canvas>
                    </div>
                </div>

                <!-- Timeline Card -->
                <div class="sidebar-card" id="timeline-section" style="display: none;">
                    <div class="sidebar-header">
                        <i class="fas fa-calendar-alt sidebar-icon"></i>
                        Daily Timeline
                    </div>
                    <div class="timeline-container" id="timeline-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-share-alt"></i> Share Bird Sightings
            </div>
            <p style="color: #64748b; margin-bottom: 20px;">
                Share these amazing bird sightings with your friends and fellow birders!
            </p>
            <div class="share-buttons">
                <button class="share-btn share-twitter" onclick="shareToTwitter()">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn share-facebook" onclick="shareToFacebook()">
                    <i class="fab fa-facebook"></i> Facebook
                </button>
                <button class="share-btn share-email" onclick="shareViaEmail()">
                    <i class="fas fa-envelope"></i> Email
                </button>
                <button class="share-btn share-copy" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> Copy Link
                </button>
            </div>
            <button class="close-modal" onclick="closeShareModal()">Close</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        let map;
        let markers = [];
        let markerClusterGroup;
        let allBirdData = [];
        let historicalData = [];
        let speciesChart;

        // Removed particles function

        // Initialize map
        function initMap() {
            map = L.map('map').setView([40.7128, -74.0060], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });
        }

        // Filter NYC only
        function filterNYCOnly(data) {
            const nycKeywords = [
                'manhattan', 'queens', 'brooklyn', 'bronx', 'staten island',
                'central park', 'prospect park', 'inwood', 'harlem', 'jamaica bay',
                'forest park', 'flushing', 'coney island', 'rockaway', 'battery park',
                'riverside park', 'fort tryon', 'pelham bay', 'van cortlandt',
                'floyd bennett', 'governors island', 'randalls island', 'east river',
                'hudson river park', 'tompkins square', 'washington square',
                'highbridge park', 'morningside park', 'stuyvesant', 'gramercy'
            ];

            return data.filter(bird => {
                const location = (bird.locName || '').toLowerCase();
                return nycKeywords.some(keyword => location.includes(keyword));
            });
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('get_latest_data.php');
                if (!response.ok) throw new Error('Could not load data');

                const allData = await response.json();
                const nycData = filterNYCOnly(allData);
                allBirdData = nycData;

                updateStats(nycData);
                displayBirdList(nycData);
                addMarkersToMap(nycData);
                updateChart(nycData);

                // Add pulse animation
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.add('new-data');
                    setTimeout(() => card.classList.remove('new-data'), 6000);
                });

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('bird-list-container').innerHTML = `
                    <div class="loading">
                        <p>Unable to load bird data.</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            Make sure the server is running and data files exist.
                        </p>
                    </div>
                `;
            }
        }

        // Update stats
        function updateStats(data) {
            const totalSightings = data.length;
            const uniqueSpecies = new Set(data.map(bird => bird.comName)).size;
            const now = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Count most spotted species
            const speciesCounts = {};
            data.forEach(bird => {
                const species = bird.comName || 'Unknown';
                speciesCounts[species] = (speciesCounts[species] || 0) + 1;
            });
            const topSpecies = Object.keys(speciesCounts).reduce((a, b) =>
                speciesCounts[a] > speciesCounts[b] ? a : b, '');

            animateNumber('total-sightings', totalSightings);
            animateNumber('unique-species', uniqueSpecies);
            document.getElementById('last-updated').textContent = now;
            document.getElementById('top-species').textContent = topSpecies.split(' ')[0] || '--';
        }

        // Animate numbers
        function animateNumber(id, target) {
            const element = document.getElementById(id);
            const duration = 1000;
            const start = parseInt(element.textContent) || 0;
            const increment = (target - start) / (duration / 16);
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        // Display bird list
        function displayBirdList(data) {
            const container = document.getElementById('bird-list-container');

            if (data.length === 0) {
                container.innerHTML = '<div class="loading">No bird sightings found.</div>';
                return;
            }

            const html = data.map((bird, index) => `
                <div class="bird-item" onclick="focusBird(${index})">
                    <div class="bird-name">
                        ${bird.comName || 'Unknown Species'}
                        <span class="bird-count">${bird.howMany || '?'} seen</span>
                    </div>
                    <div class="bird-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${bird.locName || 'Unknown location'}
                    </div>
                    <div class="bird-date">
                        <i class="fas fa-clock"></i>
                        ${bird.obsDt || 'Unknown date'}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Add markers to map
        function addMarkersToMap(data) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            markerClusterGroup.clearLayers();

            data.forEach((bird, index) => {
                if (bird.lat && bird.lng) {
                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            background: linear-gradient(135deg, #2563eb, #7c3aed);
                            width: 20px;
                            height: 20px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
                        "></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const marker = L.marker([bird.lat, bird.lng], { icon: customIcon });

                    const popupContent = `
                        <div style="font-family: 'Poppins', sans-serif; padding: 10px;">
                            <h3 style="color: #1e293b; margin-bottom: 10px; font-size: 1.2em;">
                                ${bird.comName || 'Unknown Species'}
                            </h3>
                            <p style="color: #64748b; margin: 5px 0;">
                                <strong>Scientific:</strong> ${bird.sciName || 'N/A'}
                            </p>
                            <p style="color: #64748b; margin: 5px 0;">
                                <strong>Location:</strong> ${bird.locName || 'Unknown'}
                            </p>
                            <p style="color: #64748b; margin: 5px 0;">
                                <strong>Count:</strong> ${bird.howMany || '?'} individual(s)
                            </p>
                            <p style="color: #64748b; margin: 5px 0;">
                                <strong>Date:</strong> ${bird.obsDt || 'Unknown'}
                            </p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.birdIndex = index;
                    markers.push(marker);
                    markerClusterGroup.addLayer(marker);
                }
            });

            map.addLayer(markerClusterGroup);
        }

        // Focus on bird
        function focusBird(index) {
            const bird = allBirdData[index];
            if (bird.lat && bird.lng) {
                map.setView([bird.lat, bird.lng], 14);
                const marker = markers.find(m => m.birdIndex === index);
                if (marker) {
                    marker.openPopup();
                }
            }
        }

        // Update chart
        function updateChart(data) {
            const speciesCounts = {};
            data.forEach(bird => {
                const species = bird.comName || 'Unknown';
                speciesCounts[species] = (speciesCounts[species] || 0) + 1;
            });

            const sortedSpecies = Object.entries(speciesCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            const ctx = document.getElementById('speciesChart').getContext('2d');

            if (speciesChart) {
                speciesChart.destroy();
            }

            speciesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedSpecies.map(([name]) => name.split(' ')[0]),
                    datasets: [{
                        label: 'Sightings',
                        data: sortedSpecies.map(([, count]) => count),
                        backgroundColor: 'rgba(37, 99, 235, 0.8)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = allBirdData.filter(bird => {
                    const species = (bird.comName || '').toLowerCase();
                    const location = (bird.locName || '').toLowerCase();
                    return species.includes(searchTerm) || location.includes(searchTerm);
                });
                displayBirdList(filteredData);
                addMarkersToMap(filteredData);
                updateChart(filteredData);
            });
        });

        // Load all history
        async function loadAllHistory() {
            const files = [
                'ny_rare_birds_20260128_124623.json',
                'ny_rare_birds_20260128_032010.json',
                'ny_rare_birds_20260128_031927.json'
            ];

            historicalData = [];
            let loadedCount = 0;

            for (const file of files) {
                try {
                    const response = await fetch(file);
                    if (response.ok) {
                        const data = await response.json();
                        const nycData = filterNYCOnly(data);
                        historicalData = historicalData.concat(nycData);
                        loadedCount++;
                    }
                } catch (error) {
                    console.log(`Could not load ${file}`);
                }
            }

            if (loadedCount > 0) {
                // Remove duplicates
                const uniqueData = [];
                const seen = new Set();
                for (const bird of historicalData) {
                    if (!seen.has(bird.subId)) {
                        seen.add(bird.subId);
                        uniqueData.push(bird);
                    }
                }
                historicalData = uniqueData;

                historicalData.sort((a, b) => new Date(b.obsDt) - new Date(a.obsDt));

                allBirdData = historicalData;
                updateStats(historicalData);
                displayBirdList(historicalData);
                addMarkersToMap(historicalData);
                updateChart(historicalData);
                displayTimeline(historicalData);

                alert(`âœ… Loaded ${historicalData.length} unique NYC bird sightings from ${loadedCount} files!`);
            } else {
                alert('âš ï¸ No historical data files found.');
            }
        }

        // Display timeline
        function displayTimeline(data) {
            const timelineSection = document.getElementById('timeline-section');
            const timelineContainer = document.getElementById('timeline-container');

            const byDate = {};
            data.forEach(bird => {
                const date = bird.obsDt.split(' ')[0];
                if (!byDate[date]) {
                    byDate[date] = [];
                }
                byDate[date].push(bird);
            });

            const sortedDates = Object.keys(byDate).sort((a, b) => new Date(b) - new Date(a));

            let html = '';
            sortedDates.slice(0, 10).forEach(date => {
                const birds = byDate[date];
                const uniqueSpecies = new Set(birds.map(b => b.comName)).size;
                html += `
                    <div class="timeline-item">
                        <div class="timeline-date">
                            <i class="fas fa-calendar"></i> ${date}
                        </div>
                        <div class="timeline-stats">
                            <i class="fas fa-binoculars"></i> ${birds.length} sightings â€¢
                            <i class="fas fa-dove"></i> ${uniqueSpecies} species
                        </div>
                    </div>
                `;
            });

            timelineContainer.innerHTML = html;
            timelineSection.style.display = 'block';
        }

        // Filter by date range
        function filterByDateRange() {
            const range = document.getElementById('date-range').value;
            let filteredData = historicalData.length > 0 ? historicalData : allBirdData;

            if (range !== 'all') {
                const cutoffDate = new Date();

                if (range === 'today') {
                    cutoffDate.setHours(0, 0, 0, 0);
                } else if (range === 'yesterday') {
                    cutoffDate.setDate(cutoffDate.getDate() - 1);
                    cutoffDate.setHours(0, 0, 0, 0);
                } else if (range === 'week') {
                    cutoffDate.setDate(cutoffDate.getDate() - 7);
                } else if (range === 'month') {
                    cutoffDate.setDate(cutoffDate.getDate() - 30);
                }

                filteredData = filteredData.filter(bird => {
                    const birdDate = new Date(bird.obsDt);
                    if (range === 'yesterday') {
                        const nextDay = new Date(cutoffDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        return birdDate >= cutoffDate && birdDate < nextDay;
                    }
                    return birdDate >= cutoffDate;
                });
            }

            allBirdData = filteredData;
            updateStats(filteredData);
            displayBirdList(filteredData);
            addMarkersToMap(filteredData);
            updateChart(filteredData);
        }

        // Clustering
        function enableClustering() {
            map.addLayer(markerClusterGroup);
            alert('âœ… Marker clustering enabled!');
        }

        // Heatmap (placeholder)
        function enableHeatmap() {
            alert('ðŸ”¥ Heatmap feature coming soon! This will show bird density across NYC.');
        }

        // Share modal
        function openShareModal() {
            document.getElementById('shareModal').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function shareToTwitter() {
            const text = `Check out these amazing rare bird sightings in NYC! ${allBirdData.length} birds spotted. #NYCBirds #Birding`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareToFacebook() {
            const url = window.location.href;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
        }

        function shareViaEmail() {
            const subject = 'NYC Rare Bird Sightings';
            const body = `I found ${allBirdData.length} rare bird sightings in NYC! Check them out at ${window.location.href}`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(window.location.href);
            alert('âœ… Link copied to clipboard!');
        }

        // Initialize
        window.onload = function() {
            initMap();
            loadData();
        };
    </script>
</body>
</html>
